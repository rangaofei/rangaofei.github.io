<!doctype html>



  


<html class="theme-next pisces use-motion" lang="zh-Hans">
<head>
  <meta charset="UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=edge" />
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"/>



<meta http-equiv="Cache-Control" content="no-transform" />
<meta http-equiv="Cache-Control" content="no-siteapp" />












  
  
  <link href="/lib/fancybox/source/jquery.fancybox.css?v=2.1.5" rel="stylesheet" type="text/css" />




  
  
  
  

  
    
    
  

  

  

  

  

  
    
    
    <link href="//fonts.googleapis.com/css?family=Lato:300,300italic,400,400italic,700,700italic&subset=latin,latin-ext" rel="stylesheet" type="text/css">
  






<link href="/lib/font-awesome/css/font-awesome.min.css?v=4.6.2" rel="stylesheet" type="text/css" />

<link href="/css/main.css?v=5.1.0" rel="stylesheet" type="text/css" />


  <meta name="keywords" content="Android," />








  <link rel="shortcut icon" type="image/x-icon" href="/favicon.ico?v=5.1.0" />






<meta name="description" content="关于rtp协议RTP协议介绍实时传输协议RTP（Real-time Transport Protocol）是网络传输协议的一种，构建与TCP/IP之上，广泛用于局域网推送视频与音频的推送。RTP协议本身比较复杂，而且各厂商基本不提供基于RTP协议的sdk，大多数是基于RTMP和RTSP，但是后边两者实时性远不如RTP高。为了实现将安卓手机屏幕录屏取得H264流，并将之分片或者组合发送至电脑端播放器">
<meta name="keywords" content="Android">
<meta property="og:type" content="article">
<meta property="og:title" content="移植jrtplib到安卓平台">
<meta property="og:url" content="https://rangaofei.github.io/2018/02/24/移植jrtplib到安卓平台/index.html">
<meta property="og:site_name" content="SAKA&#39;S BLOG">
<meta property="og:description" content="关于rtp协议RTP协议介绍实时传输协议RTP（Real-time Transport Protocol）是网络传输协议的一种，构建与TCP/IP之上，广泛用于局域网推送视频与音频的推送。RTP协议本身比较复杂，而且各厂商基本不提供基于RTP协议的sdk，大多数是基于RTMP和RTSP，但是后边两者实时性远不如RTP高。为了实现将安卓手机屏幕录屏取得H264流，并将之分片或者组合发送至电脑端播放器">
<meta property="og:locale" content="zh-Hans">
<meta property="og:image" content="http://p3lublj5c.bkt.clouddn.com/%E5%B1%8F%E5%B9%95%E5%BF%AB%E7%85%A7%202018-02-24%20%E4%B8%8B%E5%8D%888.18.16.png">
<meta property="og:updated_time" content="2018-02-24T12:35:39.773Z">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="移植jrtplib到安卓平台">
<meta name="twitter:description" content="关于rtp协议RTP协议介绍实时传输协议RTP（Real-time Transport Protocol）是网络传输协议的一种，构建与TCP/IP之上，广泛用于局域网推送视频与音频的推送。RTP协议本身比较复杂，而且各厂商基本不提供基于RTP协议的sdk，大多数是基于RTMP和RTSP，但是后边两者实时性远不如RTP高。为了实现将安卓手机屏幕录屏取得H264流，并将之分片或者组合发送至电脑端播放器">
<meta name="twitter:image" content="http://p3lublj5c.bkt.clouddn.com/%E5%B1%8F%E5%B9%95%E5%BF%AB%E7%85%A7%202018-02-24%20%E4%B8%8B%E5%8D%888.18.16.png">



<script type="text/javascript" id="hexo.configurations">
  var NexT = window.NexT || {};
  var CONFIG = {
    root: '/',
    scheme: 'Pisces',
    sidebar: {"position":"left","display":"post"},
    fancybox: true,
    motion: true,
    duoshuo: {
      userId: '0',
      author: '博主'
    },
    algolia: {
      applicationID: '',
      apiKey: '',
      indexName: '',
      hits: {"per_page":10},
      labels: {"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}
    }
  };
</script>



  <link rel="canonical" href="https://rangaofei.github.io/2018/02/24/移植jrtplib到安卓平台/"/>





  <title> 移植jrtplib到安卓平台 | SAKA'S BLOG </title>
</head>

<body itemscope itemtype="http://schema.org/WebPage" lang="zh-Hans">

  








  <div style="display: none;">
    <script src="https://s4.cnzz.com/z_stat.php?id=1261177704&web_id=1261177704" language="JavaScript"></script>
  <script type="text/javascript">var cnzz_protocol = (("https:" == document.location.protocol) ? " https://" : " http://");document.write(unescape("%3Cspan id='cnzz_stat_icon_1261177704'%3E%3C/span%3E%3Cscript src='" + cnzz_protocol + "s4.cnzz.com/z_stat.php%3Fid%3D1261177704%26online%3D1%26show%3Dline' type='text/javascript'%3E%3C/script%3E"));</script>
  </div>





  
  
    
  

  <div class="container one-collumn sidebar-position-left page-post-detail ">
    <div class="headband"></div>

    <header id="header" class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-meta ">
  

  <div class="custom-logo-site-title">
    <a href="/"  class="brand" rel="start">
      <span class="logo-line-before"><i></i></span>
      <span class="site-title">SAKA'S BLOG</span>
      <span class="logo-line-after"><i></i></span>
    </a>
  </div>
    
      <p class="site-subtitle"></p>
    
</div>

<div class="site-nav-toggle">
  <button>
    <span class="btn-bar"></span>
    <span class="btn-bar"></span>
    <span class="btn-bar"></span>
  </button>
</div>

<nav class="site-nav">
  

  
    <ul id="menu" class="menu">
      
        
        <li class="menu-item menu-item-home">
          <a href="/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-home"></i> <br />
            
            首页
          </a>
        </li>
      
        
        <li class="menu-item menu-item-categories">
          <a href="/categories/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-th"></i> <br />
            
            分类
          </a>
        </li>
      
        
        <li class="menu-item menu-item-archives">
          <a href="/archives/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-archive"></i> <br />
            
            归档
          </a>
        </li>
      
        
        <li class="menu-item menu-item-tags">
          <a href="/tags/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-tags"></i> <br />
            
            标签
          </a>
        </li>
      

      
    </ul>
  

  
</nav>



 </div>
    </header>

    <main id="main" class="main">
      <div class="main-inner">
        <div class="content-wrap">
          <div id="content" class="content">
            

  <div id="posts" class="posts-expand">
    

  

  
  
  

  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">
  <link itemprop="mainEntityOfPage" href="https://rangaofei.github.io/2018/02/24/移植jrtplib到安卓平台/">

  <span style="display:none" itemprop="author" itemscope itemtype="http://schema.org/Person">
    <meta itemprop="name" content="rangaofei">
    <meta itemprop="description" content="">
    <meta itemprop="image" content="http://ok7v12rvl.bkt.clouddn.com/01b18.jpg">
  </span>

  <span style="display:none" itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
    <meta itemprop="name" content="SAKA'S BLOG">
    <span style="display:none" itemprop="logo" itemscope itemtype="http://schema.org/ImageObject">
      <img style="display:none;" itemprop="url image" alt="SAKA'S BLOG" src="">
    </span>
  </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
            
            
              
                移植jrtplib到安卓平台
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="Post created" itemprop="dateCreated datePublished" datetime="2018-02-24T20:35:10+08:00">
                2018-02-24
              </time>
            

            

            
          </span>

          

          
            
          

          

          
          

          

          

        </div>
      </header>
    


    <div class="post-body" itemprop="articleBody">

      
      

      
        <h2 id="关于rtp协议"><a href="#关于rtp协议" class="headerlink" title="关于rtp协议"></a>关于rtp协议</h2><h3 id="RTP协议介绍"><a href="#RTP协议介绍" class="headerlink" title="RTP协议介绍"></a>RTP协议介绍</h3><p>实时传输协议RTP（Real-time Transport Protocol）是网络传输协议的一种，构建与TCP/IP之上，广泛用于局域网推送视频与音频的推送。RTP协议本身比较复杂，而且各厂商基本不提供基于RTP协议的sdk，大多数是基于RTMP和RTSP，但是后边两者实时性远不如RTP高。为了实现将安卓手机屏幕录屏取得H264流，并将之分片或者组合发送至电脑端播放器，延时低于1s，最后选择采用RTP协议发送。</p>
<p>RTP报文由两部分组成：报头和有效载荷。RTP报头格式如图所示，其中：</p>
<ol>
<li>V：RTP协议的版本号，占2位，当前协议版本号为2。</li>
<li>P：填充标志，占1位，如果P=1，则在该报文的尾部填充一个或多个额外的八位组，它们不是有效载荷的一部分。</li>
<li>X：扩展标志，占1位，如果X=1，则在RTP报头后跟有一个扩展报头。</li>
<li>CC：CSRC计数器，占4位，指示CSRC 标识符的个数。</li>
<li>M: 标记，占1位，不同的有效载荷有不同的含义，对于视频，标记一帧的结束；对于音频，标记会话的开始。</li>
<li>同步信源(SSRC)标识符：占32位，用于标识同步信源。该标识符是随机选择的，参加同一视频会议的两个同步信源不能有相同的SSRC。</li>
<li>特约信源(CSRC)标识符：每个CSRC标识符占32位，可以有0～15个。每个CSRC标识了包含在该RTP报文有效载荷中的所有特约信源。</li>
<li>PT: 有效载荷类型，占7位，用于说明RTP报文中有效载荷的类型，如GSM音频、JPEM图像等。</li>
<li>序列号：占16位，用于标识发送者所发送的RTP报文的序列号，每发送一个报文，序列号增1。接收者通过序列号来检测报文丢失情况，重新排序报文，恢复数据。</li>
<li>时戳(Timestamp)：占32位，时戳反映了该RTP报文的第一个八位组的采样时刻。接收者使用时戳来计算延迟和延迟抖动，并进行同步控制。</li>
</ol>
<p>这里的同步信源是指产生媒体流的信源，它通过RTP报头中的一个32位数字SSRC标识符来标识，而不依赖于网络地址，接收者将根据SSRC标识符来区分不同的信源，进行RTP报文的分组。特约信源是指当混合器接收到一个或多个同步信源的RTP报文后，经过混合处理产生一个新的组合RTP报文，并把混合器作为组合RTP报文的SSRC，而将原来所有的SSRC都作为CSRC传送给接收者，使接收者知道组成组合报文的各个SSRC。</p>
<h3 id="RTP协议的复杂封包"><a href="#RTP协议的复杂封包" class="headerlink" title="RTP协议的复杂封包"></a>RTP协议的复杂封包</h3><p>网络传输的MTU最大值一般是1400-1500字节。rtp推荐使UDP作为传输协议，为了保证数据不丢失，我们需要将H264流的NALU单元限制在MTU以内。H264流的SPS和PPS只占很少的字节，并且在画面变化很少时产生的NAL单元也很小，这时候可能需要组包发送，将两个或者多个NAL单元封装在一个包内发送；当产生的NAL单元超过MTU的限制后，假如每个载体还要传送一个NAL，则可能会丢失数据，导致接收端接收的不是完整的一帧数据，这个时候需要分包发送，将一个NAL单元拆分成两个或者更多个包发送。<br>想想头都大了，因为分包和组合包</p>
<h4 id="单一NAL单元模式"><a href="#单一NAL单元模式" class="headerlink" title="单一NAL单元模式"></a>单一NAL单元模式</h4><p>对于 NALU 的长度小于 MTU 大小的包, 一般采用单一 NAL 单元模式.<br>对于一个原始的 H.264 NALU 单元常由 [Start Code] [NALU Header] [NALU Payload] 三部分组成, 其中 Start Code 用于标示这是一个<br>NALU 单元的开始, 必须是 “00 00 00 01” 或 “00 00 01”, NALU 头仅一个字节, 其后都是 NALU 单元内容.<br>打包时去除 “00 00 01” 或 “00 00 00 01” 的开始码, 把其他数据封包的 RTP 包即可.</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"> 0                   1                   2                   3</span><br><span class="line"> 0 1 2 3 4 5 6 7 8 9 0 1 2 3 4 5 6 7 8 9 0 1 2 3 4 5 6 7 8 9 0 1</span><br><span class="line">+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+</span><br><span class="line">|F|NRI|  type   |                                               |</span><br><span class="line">+-+-+-+-+-+-+-+-+                                               |</span><br><span class="line">|                                                               |</span><br><span class="line">|               Bytes 2..n of a Single NAL unit                 |</span><br><span class="line">|                                                               |</span><br><span class="line">|                               +-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+</span><br><span class="line">|                               :...OPTIONAL RTP padding        |</span><br><span class="line">+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+</span><br></pre></td></tr></table></figure>
<h4 id="组合封包模式"><a href="#组合封包模式" class="headerlink" title="组合封包模式"></a>组合封包模式</h4><p>当 NALU 的长度特别小时, 可以把几个 NALU 单元封在一个 RTP 包中.</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"> 0                   1                   2                   3</span><br><span class="line"> 0 1 2 3 4 5 6 7 8 9 0 1 2 3 4 5 6 7 8 9 0 1 2 3 4 5 6 7 8 9 0 1</span><br><span class="line">+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+</span><br><span class="line">|                          RTP Header                           |</span><br><span class="line">+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+</span><br><span class="line">|STAP-A NAL HDR |         NALU 1 Size           | NALU 1 HDR    |</span><br><span class="line">+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+</span><br><span class="line">|                         NALU 1 Data                           |</span><br><span class="line">:                                                               :</span><br><span class="line">+               +-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+</span><br><span class="line">|               | NALU 2 Size                   | NALU 2 HDR    |</span><br><span class="line">+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+</span><br><span class="line">|                         NALU 2 Data                           |</span><br><span class="line">:                                                               :</span><br><span class="line">|                               +-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+</span><br><span class="line">|                               :...OPTIONAL RTP padding        |</span><br><span class="line">+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+</span><br></pre></td></tr></table></figure>
<h4 id="分包模式"><a href="#分包模式" class="headerlink" title="分包模式"></a>分包模式</h4><p>当NALU的长度超过MTU时,就必须对NALU单元进行分片封包.也称为Fragmentation Units(FUs).</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"> 0                   1                   2                   3</span><br><span class="line"> 0 1 2 3 4 5 6 7 8 9 0 1 2 3 4 5 6 7 8 9 0 1 2 3 4 5 6 7 8 9 0 1</span><br><span class="line">+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+</span><br><span class="line">| FU indicator  |   FU header   |                               |</span><br><span class="line">+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+                               |</span><br><span class="line">|                                                               |</span><br><span class="line">|                         FU payload                            |</span><br><span class="line">|                                                               |</span><br><span class="line">|                               +-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+</span><br><span class="line">|                               :...OPTIONAL RTP padding        |</span><br><span class="line">+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+</span><br></pre></td></tr></table></figure>
<p>这几种模式看着就很复杂，假如是非专业人士很难搞定。网上比较有名的就是ffmpeg和jrtplib，他们都对RTP协议做了较好的封装。这里我使用用C++编写的jrtplib工程移植到安卓平台。</p>
<h2 id="JRTPLIB介绍"><a href="#JRTPLIB介绍" class="headerlink" title="JRTPLIB介绍"></a>JRTPLIB介绍</h2><p>jrtplib一个用C ++编写的面向对象库，旨在帮助开发人员使用RFC 3550中描述的实时传输协议（RTP）。</p>
<p>该库使得用户可以使用RTP发送和接收数据，而不用担心SSRC冲突，调度和传输RTCP数据等。用户只需要向库提供要发送的有效载荷数据，并且该库能给用户访问传入的RTP和RTCP数据的权限。</p>
<p>jrtplib支持定义于RFC3550中的RTP协议，它使得发送和接收RTP报文变得异常简单，用户不用担心SSRC冲突，也不用考虑如何传输RTCP数据，因为RTCP功能完全在内部实现，不需用户手动操作。<br>当发送RTP报文时，用户只需简单的给发送函数提供负载数据；当接收数据时，jrtplib提供了访问传入的RTP和RTCP数据的接口。</p>
<p>目前为止，jrtplib支持以下平台：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">*GNU/Linux</span><br><span class="line">*MS-Windows（Win32和WinCE）</span><br><span class="line">*Solaris</span><br><span class="line">当然也可以运行于其他类unix环境。</span><br></pre></td></tr></table></figure>
<p>jthread封装了pthread，提供了一些特定的接口使用起来更方便一点。<br>jrtplib可以使用jthread库在后台自动轮询传入的数据，所以推荐安装jthread。当然如果没有安装jthread，jrtplib也能正常工作，但是需要用户自己轮询传入的数据了。3.x.x版本的jrtplib至少需要1.3.0版本的jthread。</p>
<p><a href="https://jrtplib.readthedocs.io/en/stable/" target="_blank" rel="noopener">jrtplib文档地址</a></p>
<p><a href="https://github.com/j0r1/JRTPLIB" target="_blank" rel="noopener">jrtplib-github地址</a></p>
<p><a href="https://github.com/j0r1/JThread" target="_blank" rel="noopener">jthread-github地址</a></p>
<p>两个库全都使用cmake构建，并且系统内提供了对主要平台的支持测试，保证在各个平台正常使用。现在我们需要借助ndk交叉编译为安卓平台的架构。</p>
<h2 id="编译jthread"><a href="#编译jthread" class="headerlink" title="编译jthread"></a>编译jthread</h2><p>官方的jthread是一个基于pthead的封装库，用来解决unix平台多线程编程。封装置后调用相对简单，使用jthread可以轮询查询是否接收到rtp包并且取出。</p>
<p>文件结构如下：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line">└── JThread</span><br><span class="line">    ├── CMakeLists.txt</span><br><span class="line">    ├── ChangeLog</span><br><span class="line">    ├── LICENSE.MIT</span><br><span class="line">    ├── README.md</span><br><span class="line">    ├── TODO</span><br><span class="line">    ├── builddist.sh</span><br><span class="line">    ├── cmake</span><br><span class="line">    │   └── JThreadConfig.cmake.in</span><br><span class="line">    ├── doc</span><br><span class="line">    │   └── manual.tex</span><br><span class="line">    ├── pkgconfig</span><br><span class="line">    │   ├── CMakeLists.txt</span><br><span class="line">    │   └── jthread.pc.in</span><br><span class="line">    ├── sphinxdoc</span><br><span class="line">    │   ├── Makefile</span><br><span class="line">    │   ├── README.md</span><br><span class="line">    │   └── source</span><br><span class="line">    │       ├── _static</span><br><span class="line">    │       ├── _templates</span><br><span class="line">    │       └── conf.py</span><br><span class="line">    └── src</span><br><span class="line">        ├── CMakeLists.txt</span><br><span class="line">        ├── jmutex.h</span><br><span class="line">        ├── jmutexautolock.h</span><br><span class="line">        ├── jthread.h</span><br><span class="line">        ├── jthreadconfig.h.in</span><br><span class="line">        ├── pthread</span><br><span class="line">        │   ├── jmutex.cpp</span><br><span class="line">        │   └── jthread.cpp</span><br><span class="line">        └── win32</span><br><span class="line">            ├── jmutex.cpp</span><br><span class="line">            └── jthread.cpp</span><br></pre></td></tr></table></figure>
<p>文件很少，主要的源文件在src文件夹下，这里的文件是实现jthread的主要代码，我们不用管，重点关注该文件夹下的<code>CMakeLists.txt</code>文件。doc、pkgconfi和spinxdoc三个文件夹是unix平台安装的文件，也可以不用管。主要的是CMakeLists.txt文件和cmake文件夹下的<code>JThreadConfig.cmake.in</code>。下面一起分析一下上面提到的三个需要关注的文件。<br>关于cmake的详细文档请参<a href="https://cmake.org/cmake/help/v3.10/index.html" target="_blank" rel="noopener">考官方文档</a>或者<a href="https://juejin.im/post/5a8ebe006fb9a0635a6574de" target="_blank" rel="noopener">这个系列文章</a>。</p>
<h3 id="根目录下的CMakeList-txt文件"><a href="#根目录下的CMakeList-txt文件" class="headerlink" title="根目录下的CMakeList.txt文件"></a>根目录下的CMakeList.txt文件</h3><p>该文件是整个工程构建系统的入口。</p>
<figure class="highlight cmake"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">cmake_minimum_required</span>(VERSION <span class="number">3.0</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">project</span>(jthread)</span><br><span class="line"><span class="keyword">set</span>(VERSION <span class="number">1.3</span>.<span class="number">3</span>)</span><br></pre></td></tr></table></figure>
<p>来看看这三个蛋疼的玩意，指定了使用cmake的最小版本，构建的工程的名称以及该库的版本。</p>
<figure class="highlight cmake"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">include</span>(CheckCXXSourceCompiles)</span><br></pre></td></tr></table></figure>
<p>这个就牛逼了，是用来测试c源码是否包含某个功能，稍后在src文件夹下CMakeLists.txt文件介绍会用到。</p>
<figure class="highlight cmake"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">set</span> (_DEFAULT_LIBRARY_INSTALL_DIR lib)</span><br><span class="line"><span class="keyword">if</span> (EXISTS <span class="string">"$&#123;CMAKE_INSTALL_PREFIX&#125;/lib32/"</span> <span class="keyword">AND</span> CMAKE_SIZEOF_VOID_P <span class="keyword">EQUAL</span> <span class="number">4</span>)</span><br><span class="line">	<span class="keyword">set</span> (_DEFAULT_LIBRARY_INSTALL_DIR lib32)</span><br><span class="line"><span class="keyword">elseif</span> (EXISTS <span class="string">"$&#123;CMAKE_INSTALL_PREFIX&#125;/lib64/"</span> <span class="keyword">AND</span> CMAKE_SIZEOF_VOID_P <span class="keyword">EQUAL</span> <span class="number">8</span>)</span><br><span class="line">	<span class="keyword">set</span> (_DEFAULT_LIBRARY_INSTALL_DIR lib64)</span><br><span class="line"><span class="keyword">endif</span> ()</span><br><span class="line"></span><br><span class="line"><span class="keyword">set</span>(LIBRARY_INSTALL_DIR <span class="string">"$&#123;_DEFAULT_LIBRARY_INSTALL_DIR&#125;"</span> CACHE PATH <span class="string">"Library installation directory"</span>)</span><br><span class="line"><span class="keyword">if</span>(NOT IS_ABSOLUTE <span class="string">"$&#123;LIBRARY_INSTALL_DIR&#125;"</span>)</span><br><span class="line">	<span class="keyword">set</span>(LIBRARY_INSTALL_DIR <span class="string">"$&#123;CMAKE_INSTALL_PREFIX&#125;/$&#123;LIBRARY_INSTALL_DIR&#125;"</span>)</span><br><span class="line"><span class="keyword">endif</span>()</span><br></pre></td></tr></table></figure>
<p>这几个是关于库的安装路径设置，暂时忽略，因为我们在交叉编译的时候会手动指定安装目录。</p>
<figure class="highlight cmake"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">find_package</span>(Threads)</span><br><span class="line"><span class="keyword">if</span> (NOT CMAKE_USE_WIN32_THREADS_INIT)</span><br><span class="line">	<span class="keyword">if</span> (NOT CMAKE_USE_PTHREADS_INIT)</span><br><span class="line">		<span class="keyword">message</span>(FATAL_ERROR <span class="string">"Can find neither pthread support nor Win32 thread support"</span>)</span><br><span class="line">	<span class="keyword">endif</span> (NOT CMAKE_USE_PTHREADS_INIT)</span><br><span class="line"><span class="keyword">endif</span> (NOT CMAKE_USE_WIN32_THREADS_INIT)</span><br></pre></td></tr></table></figure>
<p>find_package可以用来查询系统是否包含某个库，包含会返回变量成功，不包含变量返回NOTFOUND。<br>这个是用来寻找threads库，假如找到会生成以下变量:</p>
<figure class="highlight cmake"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">CMAKE_THREAD_LIBS_INIT     - 库名称</span><br><span class="line">CMAKE_USE_SPROC_INIT       - 使用sproc?</span><br><span class="line">CMAKE_USE_WIN32_THREADS_INIT - 使用WIN32 threads?</span><br><span class="line">CMAKE_USE_PTHREADS_INIT    - 使用pthreads</span><br><span class="line">CMAKE_HP_PTHREADS_INIT     - 使用pthreads</span><br></pre></td></tr></table></figure>
<p>稍后会用到其中的一些变量。<br>最后一行：</p>
<figure class="highlight cmake"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">add_subdirectory</span>(src)</span><br></pre></td></tr></table></figure>
<p>这个是提供执行构建src文件夹下的CMakeLists.txt文件的一个入口，添加这句后src中的cmake文件就可以引用这个cmake文件中的一些变量和环境设置。</p>
<h3 id="src文件夹下的CMakeLists-txt文件"><a href="#src文件夹下的CMakeLists-txt文件" class="headerlink" title="src文件夹下的CMakeLists.txt文件"></a>src文件夹下的CMakeLists.txt文件</h3><p>这个文件的内比较多，挑一些重要的讲一讲：</p>
<figure class="highlight cmake"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> (NOT MSVC <span class="keyword">OR</span> JTHREAD_COMPILE_STATIC)</span><br><span class="line">	<span class="keyword">set</span>(JTHREAD_INSTALLTARGETS jthread-static)</span><br><span class="line">	<span class="keyword">add_library</span>(jthread-static STATIC <span class="variable">$&#123;SOURCES&#125;</span> <span class="variable">$&#123;HEADERS&#125;</span>)</span><br><span class="line">	<span class="keyword">set_target_properties</span>(jthread-static PROPERTIES OUTPUT_NAME jthread)</span><br><span class="line">	<span class="keyword">set_target_properties</span>(jthread-static PROPERTIES CLEAN_DIRECT_OUTPUT <span class="number">1</span>)</span><br><span class="line">	<span class="keyword">target_link_libraries</span>(jthread-static <span class="variable">$&#123;CMAKE_THREAD_LIBS_INIT&#125;</span>)</span><br><span class="line"><span class="keyword">endif</span>()</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> ((NOT MSVC <span class="keyword">AND</span> NOT JTHREAD_COMPILE_STATIC_ONLY) <span class="keyword">OR</span> (MSVC <span class="keyword">AND</span> NOT JTHREAD_COMPILE_STATIC))</span><br><span class="line">	<span class="keyword">add_library</span>(jthread-shared SHARED <span class="variable">$&#123;SOURCES&#125;</span> <span class="variable">$&#123;HEADERS&#125;</span>)</span><br><span class="line">	<span class="keyword">set_target_properties</span>(jthread-shared PROPERTIES VERSION <span class="variable">$&#123;VERSION&#125;</span>)</span><br><span class="line">	<span class="keyword">set_target_properties</span>(jthread-shared PROPERTIES OUTPUT_NAME jthread)</span><br><span class="line">	<span class="keyword">set_target_properties</span>(jthread-shared PROPERTIES CLEAN_DIRECT_OUTPUT <span class="number">1</span>)</span><br><span class="line">	<span class="keyword">set</span>(JTHREAD_INSTALLTARGETS <span class="variable">$&#123;JTHREAD_INSTALLTARGETS&#125;</span> jthread-shared)</span><br><span class="line">	<span class="keyword">target_link_libraries</span>(jthread-shared <span class="variable">$&#123;CMAKE_THREAD_LIBS_INIT&#125;</span>)</span><br><span class="line"><span class="keyword">endif</span> ()</span><br></pre></td></tr></table></figure>
<p>这段代码的作用是在非windows平台下构建动态库和静态库，假如不需要全部构建只需要构建动态库或者静态库，注释掉其中的一部分即可(上边构建静态库.a文件，下边构建动态库.so文件)。</p>
<figure class="highlight cmake"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">install</span>(FILES <span class="variable">$&#123;HEADERS&#125;</span> DESTINATION <span class="keyword">include</span>/jthread)</span><br><span class="line"><span class="keyword">install</span>(TARGETS <span class="variable">$&#123;JTHREAD_INSTALLTARGETS&#125;</span> DESTINATION <span class="variable">$&#123;LIBRARY_INSTALL_DIR&#125;</span>)</span><br></pre></td></tr></table></figure>
<p>这两句是用来安装文件，cmake系统默认的安装路径是/usr/local/*，假如设置了<code>CMAKE_INSTALL_PREFIX</code>,则会改变默认的安装路径到该变量指向的路径。这两句话的作用是将变量<code>HEADERS</code>包含的文件-主要是头文件-安装到<code>CMAKE_INSTALL_PREFIX</code>指向路径的<code>include/jthread</code>文件夹下,同理，动态库和静态库会安装到指向路径的<code>lib</code>文件夹下。</p>
<p>关于上边提到的测试，<code>include(CheckCXXSourceCompiles)</code>：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"># Test pthread_cancel (doesn&apos;t exits on Android)</span><br><span class="line">set(CMAKE_REQUIRED_LIBRARIES $&#123;CMAKE_THREAD_LIBS_INIT&#125;)</span><br><span class="line">check_cxx_source_compiles(&quot;#include &lt;pthread.h&gt;\nint main(void) &#123; pthread_cancel((pthread_t)0); return 0; &#125;&quot; JTHREAD_HAVE_PTHREADCANCEL)</span><br><span class="line">if (NOT JTHREAD_HAVE_PTHREADCANCEL)</span><br><span class="line">    #message(&quot;Enabling JTHREAD_SKIP_PTHREAD_CANCEL&quot;)</span><br><span class="line">	add_definitions(-DJTHREAD_SKIP_PTHREAD_CANCEL)</span><br><span class="line">else ()</span><br><span class="line">	#message(&quot;pthread_cancel appears to exist&quot;)</span><br><span class="line">endif (NOT JTHREAD_HAVE_PTHREADCANCEL)</span><br></pre></td></tr></table></figure></p>
<p>这个功能是测试pthread是否有cancel函数,并将结构存储在<code>JTHREAD_HAVE_PTHREADCANCEL</code>变量中，程序执行成功则会返回true，执行失败则会返回false，然后执行if中的语句，来添加跳过执行cancel函数的变量，这样在编译后程序就不会执行cancel函数了。</p>
<p>来看一下另一端代码：</p>
<figure class="highlight cmake"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">configure_file</span>(<span class="string">"$&#123;PROJECT_SOURCE_DIR&#125;/cmake/JThreadConfig.cmake.in"</span> </span><br><span class="line">	       <span class="string">"$&#123;PROJECT_BINARY_DIR&#125;/cmake/JThreadConfig.cmake"</span>)</span><br></pre></td></tr></table></figure>
<p>configure_file的作用是将第一个参数指向的文件复制到第二个参数指向的路径，也会重命名该文件，并且在生成的文件中替换源文件中的变量。看一下源文件，指定了三个变量，后两个变量会随着你的参数指定而变化。</p>
<figure class="highlight cmake"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">set</span>(JTHREAD_FOUND <span class="number">1</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">set</span>(JTHREAD_INCLUDE_DIRS <span class="string">"$&#123;CMAKE_INSTALL_PREFIX&#125;/include"</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">set</span>(JTHREAD_LIBRARIES <span class="variable">$&#123;JTHREAD_LIBS_CMAKECONFIG&#125;</span>)</span><br></pre></td></tr></table></figure>
<p>这个文件本身并没有太大的作用，主要目的是让jrtplib寻找到jthread库。实际在jrtplib中定义的find宏中提供了两种方式，不是必须采用这种方式。</p>
<h3 id="编译全abi的jthread库"><a href="#编译全abi的jthread库" class="headerlink" title="编译全abi的jthread库"></a>编译全abi的jthread库</h3><p>用ndk-build来构建时比较简单的，但是要自己编写.mk文件。我闲的蛋疼写了一个bash脚本来生成全abi的动态库和静态库。安卓支持的abi版本共有7种，armeabi arm64-v8a armeabi-v7a mips mips64 x86 x86_64，我们需要分别生成这些版本的动态库.so文件与静态库.o文件。</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#</span>!/bin/bash</span><br><span class="line"></span><br><span class="line"><span class="meta">#</span>ndk的路径，替换为自己的路径</span><br><span class="line">export NDK_PATH=/Users/rangaofei/Library/Android/sdk/ndk-bundle</span><br><span class="line"></span><br><span class="line"><span class="meta">#</span>将要构建的架构</span><br><span class="line">TARGETS=(armeabi arm64-v8a armeabi-v7a mips mips64 x86 x86_64)</span><br><span class="line"></span><br><span class="line"><span class="meta">#</span>清除build文件夹下的内容</span><br><span class="line">function clean_build() &#123;</span><br><span class="line">	if ([ -d build ]); then</span><br><span class="line">		echo "prepare to clean cache"</span><br><span class="line">		(rm -rf ./build/*)</span><br><span class="line">		echo "complete"</span><br><span class="line">	else</span><br><span class="line">		echo "build is not a directory"</span><br><span class="line">		exit 0</span><br><span class="line">	fi</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">function prepare_build() &#123;</span><br><span class="line"><span class="meta">	#</span> 检测是否有Build文件夹，有的话删除文件夹，没有的话创建文件夹</span><br><span class="line">	if ([ -e build ]); then</span><br><span class="line">		echo "you already have build dir"</span><br><span class="line">		clean_build</span><br><span class="line">	else</span><br><span class="line">		echo "prepare to create dir build"</span><br><span class="line">		mkdir build</span><br><span class="line">	fi</span><br><span class="line">	(</span><br><span class="line">		cd build</span><br><span class="line">		for dir in $&#123;TARGETS[@]&#125;; do</span><br><span class="line">			mkdir $dir</span><br><span class="line">		done</span><br><span class="line">	)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">function prepare_target() &#123;</span><br><span class="line"><span class="meta">	#</span>检测是否有所有的target文件夹，有则删除，没有则创建</span><br><span class="line">	if ([ -e target ] &amp;&amp; [ -d target ]); then</span><br><span class="line">		echo "prepare to clean target"</span><br><span class="line">		rm -rf ./target/*</span><br><span class="line">		echo "clean target complete"</span><br><span class="line">	else</span><br><span class="line">		echo "you not have target_dir,we will create it"</span><br><span class="line">		mkdir target</span><br><span class="line">	fi</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">function create_child_dir() &#123;</span><br><span class="line">	if ([ -e target ]); then</span><br><span class="line">		(</span><br><span class="line">			cd target</span><br><span class="line">			mkdir $1</span><br><span class="line">		)</span><br><span class="line">	else</span><br><span class="line">		echo "target is not a dir"</span><br><span class="line">	fi</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">function move_to_target() &#123;</span><br><span class="line">	pwd</span><br><span class="line">	if ([ -e ./build/$1/src/libjthread.a ]); then</span><br><span class="line">		echo "prepare move target to ./target/$1"</span><br><span class="line">		cp ./build/$1/src/libjthread.a ./target/$1</span><br><span class="line">		cp ./build/$1/src/libjthread.so ./target/$1</span><br><span class="line">		echo "move to ./target/$1 finished"</span><br><span class="line">	else</span><br><span class="line">		echo "move error $1"</span><br><span class="line">	fi</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">function build_lib() &#123;</span><br><span class="line">	cd build/$1</span><br><span class="line">	cmake ../.. \</span><br><span class="line">		-DCMAKE_SYSTEM_NAME=Android \</span><br><span class="line">		-DCMAKE_SYSTEM_VERSION=21 \</span><br><span class="line">		-DCMAKE_ANDROID_ARCH_ABI=$1 \</span><br><span class="line">		-DCMAKE_ANDROID_NDK=$NDK_PATH \</span><br><span class="line">		-DCMAKE_ANDROID_STL_TYPE=gnustl_static \</span><br><span class="line">		-DCMAKE_INSTALL_PREFIX=$(pwd)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">function create_all_child_dir() &#123;</span><br><span class="line">	for dir in $&#123;TARGETS[@]&#125;; do</span><br><span class="line">		create_child_dir $dir</span><br><span class="line">		echo "$dir created"</span><br><span class="line">	done</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">function create_all_target() &#123;</span><br><span class="line">	prepare_build</span><br><span class="line">	prepare_target</span><br><span class="line">	create_all_child_dir</span><br><span class="line">	for target in $&#123;TARGETS[@]&#125;; do</span><br><span class="line">		(</span><br><span class="line">			build_lib $target</span><br><span class="line">			make</span><br><span class="line">			make install</span><br><span class="line">		)</span><br><span class="line">		move_to_target $target</span><br><span class="line">	done</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">function sbuild() &#123;</span><br><span class="line">	echo "-------$1"</span><br><span class="line">	case $1 in</span><br><span class="line">	"all")</span><br><span class="line">		create_all_target</span><br><span class="line">		;;</span><br><span class="line">	"*") ;;</span><br><span class="line"></span><br><span class="line">	esac</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">sbuild_list=("all")</span><br><span class="line">function _sbuild() &#123;</span><br><span class="line">	local cur</span><br><span class="line">	COMPREPLY=()</span><br><span class="line">	cur="$&#123;COMP_WORDS[COMP_CWORD]&#125;"</span><br><span class="line">	COMPREPLY=($(compgen -W "$&#123;sbuild_list[*]&#125;" -- $&#123;cur&#125;))</span><br><span class="line">	return 0</span><br><span class="line">&#125;</span><br><span class="line">complete -o filenames -F _sbuild sbuild</span><br></pre></td></tr></table></figure>
<p>关于shell脚本有兴趣的话可以参考<a href="https://rangaofei.github.io/tags/Shell/">系列文章</a>.</p>
<p>关于cmake构建的指令是</p>
<figure class="highlight cmake"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">cmake ../.. \</span><br><span class="line">		-DCMAKE_SYSTEM_NAME=Android \</span><br><span class="line">		-DCMAKE_SYSTEM_VERSION=<span class="number">21</span> \</span><br><span class="line">		-DCMAKE_ANDROID_ARCH_ABI=$<span class="number">1</span> \</span><br><span class="line">		-DCMAKE_ANDROID_NDK=$NDK_PATH \</span><br><span class="line">		-DCMAKE_ANDROID_STL_TYPE=gnustl_static \</span><br><span class="line">		-DCMAKE_INSTALL_PREFIX=$(pwd)</span><br></pre></td></tr></table></figure>
<p>这个命令是执行交叉编译的命令，<code>-DCMAKE_SYSTEM_NAME=Android</code>指定了编译平台是安卓平台；<code>-DCMAKE_SYSTEM_VERSION=21</code>指定了api版本是21；<code>-DCMAKE_ANDROID_ARCH_ABI=$1</code>指定了构建的abi为该函数接收的参数，因为会便利TARGETS数组，所以会执行七次；-DCMAKE_INSTALL_PREFIX=$(pwd)指定了我们上边提到的安装路径为当前目录，则会在当前目录下创建include/thread文件夹来存放头文件，lib文件夹存放库文件。</p>
<p>上边的脚本共干了以下几件事</p>
<ol>
<li>创建buil文件夹，并在build文件夹下创建七种abi文件夹库，用来执行cmake的外部构建，存放所有生成的文件。</li>
<li>创建target文件夹，并在target文件下创建七种abi文件夹库，将生成的库文件拷贝到这个文件夹下</li>
<li>遍历所有的abi，进入build对应的文件夹下，执行外部构建，并且执行make和make install完成构建</li>
<li>拷贝所有的lib文件夹下的库到对应的target文件夹下</li>
</ol>
<p>我们在命令行执行下边两个命令</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">source build.sh</span><br><span class="line">sbuild all</span><br></pre></td></tr></table></figure>
<blockquote>
<p>温馨提示：最好在bash中执行上述命令，zsh会发生未知的错误，并且不支持我编写的自动补全。</p>
</blockquote>
<p>构建会自动执行并输出日志。构建完成后来看一下目录结构</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line">.</span><br><span class="line">├── build</span><br><span class="line">│   ├── arm64-v8a</span><br><span class="line">│   ├── armeabi</span><br><span class="line">│   ├── armeabi-v7a</span><br><span class="line">│   ├── mips</span><br><span class="line">│   ├── mips64</span><br><span class="line">│   ├── x86</span><br><span class="line">│   └── x86_64</span><br><span class="line">├── cmake</span><br><span class="line">├── doc</span><br><span class="line">├── pkgconfig</span><br><span class="line">├── sphinxdoc</span><br><span class="line">│   └── source</span><br><span class="line">├── src</span><br><span class="line">│   ├── pthread</span><br><span class="line">│   └── win32</span><br><span class="line">└── target</span><br><span class="line">    ├── arm64-v8a</span><br><span class="line">    ├── armeabi</span><br><span class="line">    ├── armeabi-v7a</span><br><span class="line">    ├── mips</span><br><span class="line">    ├── mips64</span><br><span class="line">    ├── x86</span><br><span class="line">    └── x86_64</span><br></pre></td></tr></table></figure>
<p>可以看到build文件夹和target文件夹已经按我们预期好的形式创建了，并且都有对应的abi文件夹下已经生成了所有的静态库和动态库。这样我们的jthrea库就构建好了，看一下cmake文件夹下的JThradConfig.cmake文件，这个文件位于<code>build/$abi/cmake</code>文件夹下，我选的是arm64-v8a：</p>
<figure class="highlight cmake"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">set</span>(JTHREAD_FOUND <span class="number">1</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">set</span>(JTHREAD_INCLUDE_DIRS <span class="string">"/Users/rangaofei/Documents/program/JThread/build/arm64-v8a/include"</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">set</span>(JTHREAD_LIBRARIES  <span class="string">"-L/Users/rangaofei/Documents/program/JThread/build/arm64-v8a/lib"</span> <span class="string">"-ljthread"</span>)</span><br></pre></td></tr></table></figure>
<p>这里已经替换好了我当前的目录。</p>
<h2 id="编译jrtplib"><a href="#编译jrtplib" class="headerlink" title="编译jrtplib"></a>编译jrtplib</h2><p>从github上下载好后，目录结构与jthread基本相似，根目录下的CMakeLists.txt同样是构建的入口，src下是源文件，此处注意一个example文件夹，这个是用来测试jtrplib的，由于我们是安卓平台不需要这个文件夹的例子，所以找到200行左右的代码</p>
<figure class="highlight cmake"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">add_subdirectory</span>(examples)</span><br></pre></td></tr></table></figure>
<p>将它注释掉，系统就不会构建所有的examples了。</p>
<p>cmake文件夹下有一些文件，其中有三个模块供构建时使用。，重点介绍一下这个findjthread模块，其他的两个比较简单。</p>
<h3 id="findjthread-cmake模块"><a href="#findjthread-cmake模块" class="headerlink" title="findjthread.cmake模块"></a>findjthread.cmake模块</h3><p>这个模块用来寻找jthread库。上边提到了寻找jthread库可以用JThreadConfig.cmake文件来查询</p>
<figure class="highlight cmake"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">find_package</span>(JThread QUIET NO_MODULE)</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> (NOT JTHREAD_FOUND) <span class="comment"># Config file could not be found</span></span><br><span class="line">	<span class="keyword">find_path</span>(JTHREAD_INCLUDE_DIR jthread/jthread.h)</span><br><span class="line">	</span><br><span class="line">	<span class="keyword">set</span>(JTHREAD_INCLUDE_DIRS <span class="variable">$&#123;JTHREAD_INCLUDE_DIR&#125;</span>)</span><br><span class="line"></span><br><span class="line">	<span class="keyword">if</span> (UNIX)</span><br><span class="line">		<span class="keyword">find_library</span>(JTHREAD_LIBRARY jthread)</span><br><span class="line">		<span class="keyword">if</span> (JTHREAD_LIBRARY)</span><br><span class="line">			<span class="keyword">set</span>(JTHREAD_LIBRARIES <span class="variable">$&#123;JTHREAD_LIBRARY&#125;</span>)</span><br><span class="line">			<span class="keyword">find_library</span>(JTHREAD_PTHREAD_LIB pthread)</span><br><span class="line">			<span class="keyword">if</span> (JTHREAD_PTHREAD_LIB)</span><br><span class="line">				<span class="keyword">set</span>(JTHREAD_LIBRARIES <span class="variable">$&#123;JTHREAD_LIBRARY&#125;</span> <span class="variable">$&#123;JTHREAD_PTHREAD_LIB&#125;</span>)</span><br><span class="line">			<span class="keyword">endif</span>(JTHREAD_PTHREAD_LIB)</span><br><span class="line">		<span class="keyword">endif</span> (JTHREAD_LIBRARY)</span><br><span class="line">	<span class="keyword">else</span> (UNIX)</span><br><span class="line">		<span class="keyword">find_library</span>(JTHREAD_LIB_RELEASE jthread)</span><br><span class="line">		<span class="keyword">find_library</span>(JTHREAD_LIB_DEBUG jthread_d)</span><br><span class="line"></span><br><span class="line">		<span class="keyword">if</span> (JTHREAD_LIB_RELEASE <span class="keyword">OR</span> JTHREAD_LIB_DEBUG)</span><br><span class="line">			<span class="keyword">set</span>(JTHREAD_LIBRARIES <span class="string">""</span>)</span><br><span class="line">			<span class="keyword">if</span> (JTHREAD_LIB_RELEASE)</span><br><span class="line">				<span class="keyword">set</span>(JTHREAD_LIBRARIES <span class="variable">$&#123;JTHREAD_LIBRARIES&#125;</span> optimized <span class="variable">$&#123;JTHREAD_LIB_RELEASE&#125;</span>)</span><br><span class="line">			<span class="keyword">endif</span> (JTHREAD_LIB_RELEASE)</span><br><span class="line">			<span class="keyword">if</span> (JTHREAD_LIB_DEBUG)</span><br><span class="line">				<span class="keyword">set</span>(JTHREAD_LIBRARIES <span class="variable">$&#123;JTHREAD_LIBRARIES&#125;</span> debug <span class="variable">$&#123;JTHREAD_LIB_DEBUG&#125;</span>)</span><br><span class="line">			<span class="keyword">endif</span> (JTHREAD_LIB_DEBUG)</span><br><span class="line">		<span class="keyword">endif</span> (JTHREAD_LIB_RELEASE <span class="keyword">OR</span> JTHREAD_LIB_DEBUG)</span><br><span class="line">	<span class="keyword">endif</span>(UNIX)</span><br><span class="line"><span class="keyword">endif</span> (NOT JTHREAD_FOUND)</span><br><span class="line"></span><br><span class="line"><span class="keyword">include</span>(FindPackageHandleStandardArgs)</span><br><span class="line"></span><br><span class="line">find_package_handle_standard_args(JThread DEFAULT_MSG JTHREAD_INCLUDE_DIRS JTHREAD_LIBRARIES)</span><br></pre></td></tr></table></figure>
<p>这个模块中使用了find_package和find_path,那我们需要在命令行中指定一个参数：<code>CMAKE_FIND_ROOT_PATH</code>,当使用交叉编译时这个命令是用来提供find_package和find_path的寻找路径，稍后编写的shell脚本中会设置这个变量。</p>
<h3 id="找不到ifaddrs"><a href="#找不到ifaddrs" class="headerlink" title="找不到ifaddrs"></a>找不到ifaddrs</h3><p>在交叉编译的过程中，需要使用到库ifaddrs，在unix系统中这个属于必须实现的库，但是很可惜，安卓中没有，在编译的时候报错，提示找不到关于ifaddrs的函数。所以要使用这个库必须手动导入，这里为了方便我就直接拷贝过来了这两个文件，github地址是<a href="https://github.com/morristech/android-ifaddrs" target="_blank" rel="noopener">https://github.com/morristech/android-ifaddrs</a>。然后我们需要在src文件夹下的CMakeLists.txt中找到两个变量<code>HEADERS</code>和<code>SOURCES</code>，这是两个数组，前者定义了所有的头文件，后者定义了所有的源文件，我们将为ifaddrs的添加的两个文件ifaddrs.h添加到HEADERS数组，ifaddrs.c添加到SOURCES数组。</p>
<p>到这里我们的准备工作基本结束了，下一步要编写shell脚本生成全abi。<br>基本步骤与编译jthread库相似：</p>
<ol>
<li>创建buil文件夹，并在build文件夹下创建七种abi文件夹库，用来执行cmake的外部构建，存放所有生成的文件。</li>
<li>创建target文件夹，并在target文件下创建七种abi文件夹库，将生成的库文件拷贝到这个文件夹下</li>
<li>遍历所有的abi，进入build对应的文件夹下，执行外部构建，并且执行make和make install完成构建</li>
<li>拷贝所有的lib文件夹下的库到对应的target文件夹下</li>
</ol>
<p>命令相似度很高，我就不写了，真不要看一下cmake的构建指令:<br><figure class="highlight cmake"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">cmake ../.. \</span><br><span class="line">		-DCMAKE_SYSTEM_NAME=Android \</span><br><span class="line">		-DCMAKE_SYSTEM_VERSION=<span class="number">21</span> \</span><br><span class="line">		-DCMAKE_ANDROID_ARCH_ABI=$<span class="number">1</span> \</span><br><span class="line">		-DCMAKE_ANDROID_NDK=$NDK_PATH \</span><br><span class="line">		-DCMAKE_ANDROID_STL_TYPE=gnustl_static \</span><br><span class="line">		-DCMAKE_INSTALL_PREFIX=$(pwd) \</span><br><span class="line">        -DCMAKE_FIND_ROOT_PATH=/Users/rangaofei/Documents/program/JThread/build/$<span class="number">1</span></span><br></pre></td></tr></table></figure></p>
<p>除了最后一行，其他与jthread的构建基本一致。<br>最后指定了一个变量<code>-DCMAKE_FIND_ROOT_PATH</code>,这变量就是我们前边提到的寻找jthread的文件夹路径。</p>
<p>执行命令</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">surce build.sh</span><br><span class="line">sbuild all</span><br></pre></td></tr></table></figure>
<blockquote>
<p>温馨提示：最好在bash中执行上述命令，zsh会发生未知的错误，并且不支持我编写的自动补全。</p>
</blockquote>
<p>这个库文件较多，构建时间会很长：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line">.</span><br><span class="line">├── build</span><br><span class="line">│   ├── arm64-v8a</span><br><span class="line">│   ├── armeabi</span><br><span class="line">│   ├── armeabi-v7a</span><br><span class="line">│   ├── mips</span><br><span class="line">│   ├── mips64</span><br><span class="line">│   ├── x86</span><br><span class="line">│   └── x86_64</span><br><span class="line">├── cmake</span><br><span class="line">├── doc</span><br><span class="line">├── examples</span><br><span class="line">├── pkgconfig</span><br><span class="line">├── sphinxdoc</span><br><span class="line">│   └── source</span><br><span class="line">├── src</span><br><span class="line">│   ├── extratransmitters</span><br><span class="line">│   └── ifaddrs</span><br><span class="line">├── target</span><br><span class="line">│   ├── arm64-v8a</span><br><span class="line">│   ├── armeabi</span><br><span class="line">│   ├── armeabi-v7a</span><br><span class="line">│   ├── mips</span><br><span class="line">│   ├── mips64</span><br><span class="line">│   ├── x86</span><br><span class="line">│   └── x86_64</span><br><span class="line">├── tests</span><br><span class="line">└── tools</span><br></pre></td></tr></table></figure>
<p>构建完成后同样在build和target文件夹下生成了这么多库。</p>
<h2 id="JNI调用"><a href="#JNI调用" class="headerlink" title="JNI调用"></a>JNI调用</h2><p>终于到最后一步了,我们编写了这么蛋疼的东西只为这一下。此处以静态库.a文件作为导入库，修改CMakeLists.txt文件如下：</p>
<figure class="highlight cmake"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">cmake_minimum_required</span>(VERSION <span class="number">3.4</span>.<span class="number">1</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">add_library</span>(native-lib</span><br><span class="line">            SHARED</span><br><span class="line">            src/main/cpp/native-lib.cpp )</span><br><span class="line"><span class="keyword">add_library</span>( jrtp</span><br><span class="line">             STATIC</span><br><span class="line">             IMPORTED )</span><br><span class="line"><span class="keyword">set_target_properties</span>(jrtp PROPERTIES IMPORTED_LOCATION</span><br><span class="line"><span class="variable">$&#123;CMAKE_SOURCE_DIR&#125;</span>/src/main/jniLibs/<span class="variable">$&#123;ANDROID_ABI&#125;</span>/libjrtp.a)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">add_library</span>(jthread STATIC IMPORTED)</span><br><span class="line"><span class="keyword">set_target_properties</span>(jthread PROPERTIES IMPORTED_LOCATION</span><br><span class="line"><span class="variable">$&#123;CMAKE_SOURCE_DIR&#125;</span>/src/main/jniLibs/<span class="variable">$&#123;ANDROID_ABI&#125;</span>/libjthread.a)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">include_directories</span>(</span><br><span class="line">             src/main/cpp/<span class="keyword">include</span>/jrtplib3</span><br><span class="line">             src/main/cpp/<span class="keyword">include</span></span><br><span class="line">            )</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">find_library</span>( <span class="comment"># Sets the name of the path variable.</span></span><br><span class="line">              log-lib</span><br><span class="line"></span><br><span class="line">              <span class="comment"># Specifies the name of the NDK library that</span></span><br><span class="line">              <span class="comment"># you want CMake to locate.</span></span><br><span class="line">              log )</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">target_link_libraries</span>( <span class="comment"># Specifies the target library.</span></span><br><span class="line">                       native-lib</span><br><span class="line"></span><br><span class="line">                       <span class="comment"># Links the target library to the log library</span></span><br><span class="line">                       <span class="comment"># included in the NDK.</span></span><br><span class="line">                       <span class="variable">$&#123;log-lib&#125;</span></span><br><span class="line">                      )</span><br><span class="line"></span><br><span class="line"><span class="keyword">target_link_libraries</span>(native-lib jrtp jthread)</span><br></pre></td></tr></table></figure>
<p>native-lib是我们的目标库，jrtp和jthread是我们自己构建好的库导入进来的，所以在导入库的时候指定了IMPORT属性，并且指定了properties中库的路径，否则系统会提示连接失败。</p>
<p>我们工程中src/main中的主要文件夹如下:</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line">-- cpp</span><br><span class="line">|   `-- include</span><br><span class="line">|       |-- jrtplib3</span><br><span class="line">|       `-- jthread</span><br><span class="line">|-- java</span><br><span class="line">|   `-- com</span><br><span class="line">|       `-- saka</span><br><span class="line">|-- jniLibs</span><br><span class="line">|   |-- arm64-v8a</span><br><span class="line">|   |-- armeabi</span><br><span class="line">|   |-- armeabi-v7a</span><br><span class="line">|   |-- mips</span><br><span class="line">|   |-- mips64</span><br><span class="line">|   |-- x86</span><br><span class="line">|   `-- x86_64</span><br><span class="line">`-- res</span><br><span class="line">    |-- drawable</span><br><span class="line">    |-- drawable-v24</span><br><span class="line">    |-- layout</span><br><span class="line">    |-- mipmap-anydpi-v26</span><br><span class="line">    |-- mipmap-hdpi</span><br><span class="line">    |-- mipmap-mdpi</span><br><span class="line">    |-- mipmap-xhdpi</span><br><span class="line">    |-- mipmap-xxhdpi</span><br><span class="line">    |-- mipmap-xxxhdpi</span><br><span class="line">    `-- values</span><br></pre></td></tr></table></figure>
<p>cpp文件夹下有native-lib.cpp文件和include文件夹，include文件夹下有所有的jrpt和jthread头文件。</p>
<p>jniLibs文件夹中存放着所有的abi文件夹，也就是所有的库文件：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line">|-- arm64-v8a</span><br><span class="line">|   |-- libjrtp.a</span><br><span class="line">|   |-- libjrtp.so</span><br><span class="line">|   `-- libjthread.a</span><br><span class="line">|-- armeabi</span><br><span class="line">|   |-- libjrtp.a</span><br><span class="line">|   |-- libjrtp.so</span><br><span class="line">|   `-- libjthread.a</span><br><span class="line">|-- armeabi-v7a</span><br><span class="line">|   |-- libjrtp.a</span><br><span class="line">|   |-- libjrtp.so</span><br><span class="line">|   `-- libjthread.a</span><br><span class="line">|-- mips</span><br><span class="line">|   |-- libjrtp.a</span><br><span class="line">|   |-- libjrtp.so</span><br><span class="line">|   `-- libjthread.a</span><br><span class="line">|-- mips64</span><br><span class="line">|   |-- libjrtp.a</span><br><span class="line">|   |-- libjrtp.so</span><br><span class="line">|   `-- libjthread.a</span><br><span class="line">|-- x86</span><br><span class="line">|   |-- libjrtp.a</span><br><span class="line">|   |-- libjrtp.so</span><br><span class="line">|   `-- libjthread.a</span><br><span class="line">`-- x86_64</span><br><span class="line">    |-- libjrtp.a</span><br><span class="line">    |-- libjrtp.so</span><br><span class="line">    `-- libjthread.a</span><br></pre></td></tr></table></figure>
<p>这里我把libjrtp.so文件也复制进来了，为了方便下边讲解如何用动态库构建项目。</p>
<p>依赖动态库构建相对简单一些，因为不需要传递依赖我们native-lib库依赖了jtrp,而jrtp依赖了jthread，在使用静态库的时候需要指定链接所有的依赖库，而使用动态库可以不用，值需要依赖jrtp：</p>
<figure class="highlight cmake"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">cmake_minimum_required</span>(VERSION <span class="number">3.4</span>.<span class="number">1</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">add_library</span>(native-lib</span><br><span class="line">            SHARED</span><br><span class="line">            src/main/cpp/native-lib.cpp )</span><br><span class="line"><span class="keyword">add_library</span>( jrtp</span><br><span class="line">               SHARED</span><br><span class="line">             <span class="comment"># STATIC</span></span><br><span class="line">             IMPORTED )</span><br><span class="line"><span class="keyword">set_target_properties</span>(jrtp PROPERTIES IMPORTED_LOCATION</span><br><span class="line"><span class="variable">$&#123;CMAKE_SOURCE_DIR&#125;</span>/src/main/jniLibs/<span class="variable">$&#123;ANDROID_ABI&#125;</span>/libjrtp.so)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># add_library(jthread STATIC IMPORTED)</span></span><br><span class="line"><span class="comment"># set_target_properties(jthread PROPERTIES IMPORTED_LOCATION</span></span><br><span class="line"><span class="comment"># $&#123;CMAKE_SOURCE_DIR&#125;/src/main/jniLibs/$&#123;ANDROID_ABI&#125;/libjthread.a)</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">include_directories</span>(</span><br><span class="line">             src/main/cpp/<span class="keyword">include</span>/jrtplib3</span><br><span class="line">             src/main/cpp/<span class="keyword">include</span></span><br><span class="line">            )</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">find_library</span>( <span class="comment"># Sets the name of the path variable.</span></span><br><span class="line">              log-lib</span><br><span class="line"></span><br><span class="line">              <span class="comment"># Specifies the name of the NDK library that</span></span><br><span class="line">              <span class="comment"># you want CMake to locate.</span></span><br><span class="line">              log )</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">target_link_libraries</span>( <span class="comment"># Specifies the target library.</span></span><br><span class="line">                       native-lib</span><br><span class="line"></span><br><span class="line">                       <span class="comment"># Links the target library to the log library</span></span><br><span class="line">                       <span class="comment"># included in the NDK.</span></span><br><span class="line">                       <span class="variable">$&#123;log-lib&#125;</span></span><br><span class="line">                      )</span><br><span class="line"></span><br><span class="line"><span class="comment"># target_link_libraries(native-lib jrtp jthread)</span></span><br><span class="line"><span class="keyword">target_link_libraries</span>(native-lib jrtp)</span><br></pre></td></tr></table></figure>
<p>去除了jthread依赖，指定了jrtp为SHARED动态库，修改了路径指向了libjrtp.so文件，同时删除了最后的依赖jthread。</p>
<p>native-lib.cpp中的主要代码如下：</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line">destport = <span class="number">8006</span>;</span><br><span class="line"></span><br><span class="line">num = <span class="number">10</span>;</span><br><span class="line"></span><br><span class="line">RTPUDPv4TransmissionParams transparams;</span><br><span class="line">RTPSessionParams sessparams;</span><br><span class="line">sessparams.SetOwnTimestampUnit(<span class="number">1.0</span> / <span class="number">10.0</span>);</span><br><span class="line"></span><br><span class="line">sessparams.SetAcceptOwnPackets(<span class="literal">true</span>);</span><br><span class="line">transparams.SetPortbase(portbase);</span><br><span class="line">status = sess.Create(sessparams, &amp;transparams);</span><br><span class="line">checkerror(status);</span><br><span class="line"><span class="keyword">uint8_t</span> localip[] = &#123;<span class="number">192</span>, <span class="number">168</span>, <span class="number">31</span>, <span class="number">122</span>&#125;;</span><br><span class="line"><span class="function">RTPIPv4Address <span class="title">addr</span><span class="params">(localip, destport)</span></span>;</span><br><span class="line">status = sess.AddDestination(addr);</span><br><span class="line">checkerror(status);</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    sess.EndDataAccess();</span><br><span class="line"></span><br><span class="line">    RTPTime::Wait(RTPTime(<span class="number">1</span>, <span class="number">0</span>));</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>这个是引用的example1<br>中的例子，向主机发送10次以rtp协议包好的”1234567890”字符串，每发送一次会打印一次日志到控制台。端口最好设置为偶数。<br>我们运行一下程序，控制台日志如下：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">02-24 20:15:16.760 10059-10114/com.saka.myapplication E/System.out.c: Sending packet</span><br><span class="line">02-24 20:15:17.760 10059-10114/com.saka.myapplication E/System.out.c: Sending packet</span><br><span class="line">02-24 20:15:18.770 10059-10114/com.saka.myapplication E/System.out.c: Sending packet</span><br><span class="line">02-24 20:15:19.760 10059-10114/com.saka.myapplication E/System.out.c: Sending packet</span><br><span class="line">02-24 20:15:20.770 10059-10114/com.saka.myapplication E/System.out.c: Sending packet</span><br><span class="line">02-24 20:15:21.770 10059-10114/com.saka.myapplication E/System.out.c: Sending packet</span><br><span class="line">02-24 20:15:22.770 10059-10114/com.saka.myapplication E/System.out.c: Sending packet</span><br><span class="line">02-24 20:15:23.770 10059-10114/com.saka.myapplication E/System.out.c: Sending packet</span><br><span class="line">02-24 20:15:24.770 10059-10114/com.saka.myapplication E/System.out.c: Sending packet</span><br></pre></td></tr></table></figure>
<p>可以看到数据发送成功了，每隔一秒钟数据发送一次，共十次。</p>
<p>由于我在mac上调试，小程序用不到wireshark这种大型软件，推荐一个移植mac平台的socket调试小工具-<a href="https://juejin.im/post/5a77cb456fb9a0634e6c6c14" target="_blank" rel="noopener">sokit</a>，体积小，使用简便.</p>
<p>启动程序后监听到的数据如下:</p>
<p><img src="http://p3lublj5c.bkt.clouddn.com/%E5%B1%8F%E5%B9%95%E5%BF%AB%E7%85%A7%202018-02-24%20%E4%B8%8B%E5%8D%888.18.16.png" alt="监听数据"></p>
<p>此处没有解析rtp协议，因为是测试性质的。假如需要解析rtp数据，wireshark内置解析器。</p>

      
    </div>

    <div>
      
        

      
    </div>

    <div>
      
        

      
    </div>


    <footer class="post-footer">
      
        <div class="post-tags">
          
            <a href="/tags/Android/" rel="tag"># Android</a>
          
        </div>
      

      
        <div class="post-nav">
          <div class="post-nav-next post-nav-item">
            
              <a href="/2018/02/22/shell脚本生成安卓全abi动态库与静态库/" rel="next" title="shell脚本生成安卓全abi动态库与静态库">
                <i class="fa fa-chevron-left"></i> shell脚本生成安卓全abi动态库与静态库
              </a>
            
          </div>

          <span class="post-nav-divider"></span>

          <div class="post-nav-prev post-nav-item">
            
          </div>
        </div>
      

      
      
    </footer>
  </article>



    <div class="post-spread">
      
    </div>
  </div>

          
          </div>
          


          
  <div class="comments" id="comments">
    
  </div>


        </div>
        
          
  
  <div class="sidebar-toggle">
    <div class="sidebar-toggle-line-wrap">
      <span class="sidebar-toggle-line sidebar-toggle-line-first"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-middle"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-last"></span>
    </div>
  </div>

  <aside id="sidebar" class="sidebar">
    <div class="sidebar-inner">

      

      
        <ul class="sidebar-nav motion-element">
          <li class="sidebar-nav-toc sidebar-nav-active" data-target="post-toc-wrap" >
            文章目录
          </li>
          <li class="sidebar-nav-overview" data-target="site-overview">
            站点概览
          </li>
        </ul>
      

      <section class="site-overview sidebar-panel">
        <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
          <img class="site-author-image" itemprop="image"
               src="http://ok7v12rvl.bkt.clouddn.com/01b18.jpg"
               alt="rangaofei" />
          <p class="site-author-name" itemprop="name">rangaofei</p>
          <p class="site-description motion-element" itemprop="description"></p>
        </div>
        <nav class="site-state motion-element">
        
          
            <div class="site-state-item site-state-posts">
              <a href="/archives/">
                <span class="site-state-item-count">60</span>
                <span class="site-state-item-name">日志</span>
              </a>
            </div>
          

          
            <div class="site-state-item site-state-categories">
              <a href="/categories/">
                <span class="site-state-item-count">9</span>
                <span class="site-state-item-name">分类</span>
              </a>
            </div>
          

          
            <div class="site-state-item site-state-tags">
              <a href="/tags/">
                <span class="site-state-item-count">5</span>
                <span class="site-state-item-name">标签</span>
              </a>
            </div>
          

        </nav>

        

        <div class="links-of-author motion-element">
          
        </div>

        
        

        
        

        


      </section>

      
      <!--noindex-->
        <section class="post-toc-wrap motion-element sidebar-panel sidebar-panel-active">
          <div class="post-toc">

            
              
            

            
              <div class="post-toc-content"><ol class="nav"><li class="nav-item nav-level-2"><a class="nav-link" href="#关于rtp协议"><span class="nav-number">1.</span> <span class="nav-text">关于rtp协议</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#RTP协议介绍"><span class="nav-number">1.1.</span> <span class="nav-text">RTP协议介绍</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#RTP协议的复杂封包"><span class="nav-number">1.2.</span> <span class="nav-text">RTP协议的复杂封包</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#单一NAL单元模式"><span class="nav-number">1.2.1.</span> <span class="nav-text">单一NAL单元模式</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#组合封包模式"><span class="nav-number">1.2.2.</span> <span class="nav-text">组合封包模式</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#分包模式"><span class="nav-number">1.2.3.</span> <span class="nav-text">分包模式</span></a></li></ol></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#JRTPLIB介绍"><span class="nav-number">2.</span> <span class="nav-text">JRTPLIB介绍</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#编译jthread"><span class="nav-number">3.</span> <span class="nav-text">编译jthread</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#根目录下的CMakeList-txt文件"><span class="nav-number">3.1.</span> <span class="nav-text">根目录下的CMakeList.txt文件</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#src文件夹下的CMakeLists-txt文件"><span class="nav-number">3.2.</span> <span class="nav-text">src文件夹下的CMakeLists.txt文件</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#编译全abi的jthread库"><span class="nav-number">3.3.</span> <span class="nav-text">编译全abi的jthread库</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#编译jrtplib"><span class="nav-number">4.</span> <span class="nav-text">编译jrtplib</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#findjthread-cmake模块"><span class="nav-number">4.1.</span> <span class="nav-text">findjthread.cmake模块</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#找不到ifaddrs"><span class="nav-number">4.2.</span> <span class="nav-text">找不到ifaddrs</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#JNI调用"><span class="nav-number">5.</span> <span class="nav-text">JNI调用</span></a></li></ol></div>
            

          </div>
        </section>
      <!--/noindex-->
      

    </div>
  </aside>


        
      </div>
    </main>

    <footer id="footer" class="footer">
      <div class="footer-inner">
        <div class="copyright" >
  
  &copy; 
  <span itemprop="copyrightYear">2018</span>
  <span class="with-love">
    <i class="fa fa-heart"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">rangaofei</span>
</div>


<div class="powered-by">
  由 <a class="theme-link" href="https://hexo.io">Hexo</a> 强力驱动
</div>

<div class="theme-info">
  主题 -
  <a class="theme-link" href="https://github.com/iissnan/hexo-theme-next">
    NexT.Pisces
  </a>
</div>


        

        
      </div>
    </footer>

    <div class="back-to-top">
      <i class="fa fa-arrow-up"></i>
    </div>
  </div>

  

<script type="text/javascript">
  if (Object.prototype.toString.call(window.Promise) !== '[object Function]') {
    window.Promise = null;
  }
</script>









  




  
  <script type="text/javascript" src="/lib/jquery/index.js?v=2.1.3"></script>

  
  <script type="text/javascript" src="/lib/fastclick/lib/fastclick.min.js?v=1.0.6"></script>

  
  <script type="text/javascript" src="/lib/jquery_lazyload/jquery.lazyload.js?v=1.9.7"></script>

  
  <script type="text/javascript" src="/lib/velocity/velocity.min.js?v=1.2.1"></script>

  
  <script type="text/javascript" src="/lib/velocity/velocity.ui.min.js?v=1.2.1"></script>

  
  <script type="text/javascript" src="/lib/fancybox/source/jquery.fancybox.pack.js?v=2.1.5"></script>


  


  <script type="text/javascript" src="/js/src/utils.js?v=5.1.0"></script>

  <script type="text/javascript" src="/js/src/motion.js?v=5.1.0"></script>



  
  


  <script type="text/javascript" src="/js/src/affix.js?v=5.1.0"></script>

  <script type="text/javascript" src="/js/src/schemes/pisces.js?v=5.1.0"></script>



  
  <script type="text/javascript" src="/js/src/scrollspy.js?v=5.1.0"></script>
<script type="text/javascript" src="/js/src/post-details.js?v=5.1.0"></script>



  


  <script type="text/javascript" src="/js/src/bootstrap.js?v=5.1.0"></script>



  



  




	





  





  

  
      <!-- UY BEGIN -->
      <script type="text/javascript" src="http://v2.uyan.cc/code/uyan.js?uid="></script>
      <!-- UY END -->
  




  
  

  

  

  

  


</body>
</html>
